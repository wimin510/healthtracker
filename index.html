import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp } from 'firebase/firestore';
import { getAnalytics } from "firebase/analytics";
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { Camera, Clock, Activity, Utensils, TrendingUp, Plus, Trash2, Zap, Brain, Upload } from 'lucide-react';

// Firebase 配置 - 整合使用者提供的資訊
const providedConfig = {
  apiKey: "AIzaSyC1tQrufiWrCou-C0ibw5y5KHcFVJL-CcY",
  authDomain: "heathtracker.firebaseapp.com",
  projectId: "heathtracker",
  storageBucket: "heathtracker.firebasestorage.app",
  messagingSenderId: "656865338644",
  appId: "1:656865338644:web:8707edf3db8c398297ce01",
  measurementId: "G-9600W2EDXF"
};

// 優先使用環境變數，若無則使用提供的 config
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : providedConfig;

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
// Analytics 僅在瀏覽器環境且支援時啟動
if (typeof window !== "undefined") {
  try { getAnalytics(app); } catch (e) { console.log("Analytics not supported"); }
}

const appId = typeof __app_id !== 'undefined' ? __app_id : 'heathtracker';

export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('fasting');
  const [weightLogs, setWeightLogs] = useState([]);
  const [dietLogs, setDietLogs] = useState([]);
  const [exerciseLogs, setExerciseLogs] = useState([]);
  const [isFasting, setIsFasting] = useState(false);
  const [fastingStartTime, setFastingStartTime] = useState(null);
  const [analysisLoading, setAnalysisLoading] = useState(false);
  const [apiKey] = useState(""); // 環境自動提供

  // 1. 初始化驗證 (RULE 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth failed", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. 獲取數據 (RULE 1 & 2)
  useEffect(() => {
    if (!user) return;

    const weightRef = collection(db, 'artifacts', appId, 'users', user.uid, 'weight');
    const dietRef = collection(db, 'artifacts', appId, 'users', user.uid, 'diet');
    const exerciseRef = collection(db, 'artifacts', appId, 'users', user.uid, 'exercise');
    const fastingDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'fastingState');

    const unsubWeight = onSnapshot(weightRef, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setWeightLogs(data.sort((a, b) => new Date(a.date) - new Date(b.date)));
    }, (err) => console.error("Weight fetch error:", err));

    const unsubDiet = onSnapshot(dietRef, (snapshot) => {
      setDietLogs(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    }, (err) => console.error("Diet fetch error:", err));

    const unsubExercise = onSnapshot(exerciseRef, (snapshot) => {
      setExerciseLogs(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    }, (err) => console.error("Exercise fetch error:", err));

    const unsubFasting = onSnapshot(fastingDoc, (snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.data();
        setIsFasting(data.isFasting);
        setFastingStartTime(data.startTime?.toDate());
      }
    }, (err) => console.error("Fasting state fetch error:", err));

    return () => {
      unsubWeight();
      unsubDiet();
      unsubExercise();
      unsubFasting();
    };
  }, [user]);

  // --- 核心功能函數 ---

  const toggleFasting = async () => {
    if (!user) return;
    const newState = !isFasting;
    const startTime = newState ? new Date() : null;
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'fastingState'), {
      isFasting: newState,
      startTime: startTime,
      updatedAt: serverTimestamp()
    });
  };

  const addWeight = async (e) => {
    e.preventDefault();
    const weight = e.target.weight.value;
    if (!user || !weight) return;
    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'weight'), {
      value: parseFloat(weight),
      date: new Date().toISOString().split('T')[0],
      timestamp: serverTimestamp()
    });
    e.target.reset();
  };

  const handleImageUpload = async (e, type) => {
    const file = e.target.files[0];
    if (!file || !user) return;

    setAnalysisLoading(true);
    const reader = new FileReader();
    reader.onload = async () => {
      const base64Data = reader.result.split(',')[1];
      
      const prompt = type === 'diet' 
        ? "請分析這張食物照片。提供：1.食物名稱 2.估算總熱量(kcal) 3.宏量營養素 4.給予一條健康建議。繁體中文回答。"
        : "這是 Garmin 運動截圖。提取：1.運動類型 2.距離 3.時間 4.消耗熱量 5.心率。繁體中文回答。";

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64Data } }]
            }]
          })
        });

        const result = await response.json();
        const analysis = result.candidates?.[0]?.content?.parts?.[0]?.text || "無法分析圖片，請再試一次。";

        const collectionName = type === 'diet' ? 'diet' : 'exercise';
        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, collectionName), {
          analysis,
          imageUrl: reader.result,
          timestamp: serverTimestamp(),
          date: new Date().toLocaleDateString()
        });
      } catch (err) {
        console.error("Analysis failed", err);
      } finally {
        setAnalysisLoading(false);
      }
    };
    reader.readAsDataURL(file);
  };

  const [timeLeft, setTimeLeft] = useState("");
  useEffect(() => {
    if (!isFasting || !fastingStartTime) {
      setTimeLeft("");
      return;
    }
    const timer = setInterval(() => {
      const now = new Date();
      const diff = now - fastingStartTime;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const secs = Math.floor((diff % (1000 * 60)) / 1000);
      setTimeLeft(`${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`);
    }, 1000);
    return () => clearInterval(timer);
  }, [isFasting, fastingStartTime]);

  return (
    <div className="min-h-screen bg-slate-50 pb-20 font-sans text-slate-900">
      <header className="bg-white p-4 shadow-sm sticky top-0 z-10 flex justify-between items-center">
        <h1 className="text-xl font-bold text-indigo-600 flex items-center gap-2">
          <Zap className="fill-indigo-600" /> 健康追蹤 168
        </h1>
        {user && <span className="text-[10px] text-slate-400 bg-slate-100 px-2 py-1 rounded">UID: {user.uid.slice(0, 8)}</span>}
      </header>

      <main className="max-w-md mx-auto p-4 space-y-6">
        
        {activeTab === 'fasting' && (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
            <div className="bg-white rounded-3xl p-8 shadow-xl text-center border border-slate-100">
              <h2 className="text-slate-500 font-medium mb-2">{isFasting ? '目前正在斷食中' : '目前是進食區間'}</h2>
              <div className="text-5xl font-mono font-bold text-slate-800 my-6">
                {isFasting ? timeLeft : "00:00:00"}
              </div>
              <div className="relative w-48 h-48 mx-auto mb-8">
                <div className={`absolute inset-0 rounded-full border-8 ${isFasting ? 'border-indigo-100' : 'border-emerald-100'}`}></div>
                <div className={`absolute inset-0 rounded-full border-8 ${isFasting ? 'border-indigo-500' : 'border-emerald-500'} border-t-transparent animate-spin-slow`}></div>
                <div className="absolute inset-0 flex items-center justify-center">
                   {isFasting ? <Clock size={48} className="text-indigo-500" /> : <Utensils size={48} className="text-emerald-500" />}
                </div>
              </div>
              <button 
                onClick={toggleFasting}
                className={`w-full py-4 rounded-2xl font-bold text-lg shadow-lg transition-all active:scale-95 ${
                  isFasting ? 'bg-slate-800 text-white' : 'bg-indigo-600 text-white hover:bg-indigo-700'
                }`}
              >
                {isFasting ? '結束斷食' : '開始斷食'}
              </button>
            </div>
          </div>
        )}

        {activeTab === 'logs' && (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
            <div className="grid grid-cols-2 gap-4">
              <label className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-slate-50">
                <Camera className="text-orange-500" />
                <span className="text-sm font-medium">記錄飲食</span>
                <input type="file" accept="image/*" className="hidden" onChange={(e) => handleImageUpload(e, 'diet')} />
              </label>
              <label className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-slate-50">
                <Activity className="text-blue-500" />
                <span className="text-sm font-medium">運動截圖</span>
                <input type="file" accept="image/*" className="hidden" onChange={(e) => handleImageUpload(e, 'exercise')} />
              </label>
            </div>

            {analysisLoading && (
              <div className="bg-indigo-50 p-4 rounded-xl flex items-center gap-3 text-indigo-700">
                <Brain className="animate-pulse" />
                <span className="text-sm font-medium">AI 正在分析影像數據...</span>
              </div>
            )}

            <div className="space-y-4">
              <h3 className="font-bold flex items-center gap-2 px-1"><Clock size={18} /> 最近活動</h3>
              {[...dietLogs, ...exerciseLogs]
                .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))
                .map((log) => (
                <div key={log.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                  <div className="flex gap-4">
                    <img src={log.imageUrl} alt="Log" className="w-20 h-20 rounded-lg object-cover bg-slate-100 flex-shrink-0" />
                    <div className="flex-1 min-w-0">
                      <div className="flex justify-between items-start mb-1">
                        <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold uppercase ${log.analysis.includes('運動') || log.analysis.includes('Garmin') ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'}`}>
                          {log.analysis.includes('運動') || log.analysis.includes('Garmin') ? '運動' : '飲食'}
                        </span>
                        <span className="text-[10px] text-slate-400">{log.date}</span>
                      </div>
                      <p className="text-xs text-slate-600 whitespace-pre-wrap leading-relaxed">{log.analysis}</p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {activeTab === 'weight' && (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
              <h3 className="font-bold mb-4">體重趨勢</h3>
              <div className="h-48 w-full">
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={weightLogs}>
                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                    <XAxis dataKey="date" hide />
                    <YAxis domain={['dataMin - 1', 'dataMax + 1']} hide />
                    <Tooltip contentStyle={{ borderRadius: '12px', border: 'none' }} />
                    <Line type="monotone" dataKey="value" stroke="#6366f1" strokeWidth={3} dot={{ r: 4 }} />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </div>

            <form onSubmit={addWeight} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex gap-2">
              <input name="weight" type="number" step="0.1" placeholder="今日體重 (kg)" className="flex-1 bg-slate-50 border-none rounded-xl px-4 py-2" />
              <button type="submit" className="bg-indigo-600 text-white p-2 rounded-xl"><Plus /></button>
            </form>

            <div className="space-y-2">
              {weightLogs.slice().reverse().map(log => (
                <div key={log.id} className="bg-white px-4 py-3 rounded-xl flex justify-between items-center border border-slate-50">
                  <span className="font-medium">{log.value} kg</span>
                  <span className="text-xs text-slate-400">{log.date}</span>
                </div>
              ))}
            </div>
          </div>
        )}
      </main>

      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 flex justify-around p-3 z-20">
        <button onClick={() => setActiveTab('fasting')} className={`flex flex-col items-center gap-1 ${activeTab === 'fasting' ? 'text-indigo-600' : 'text-slate-400'}`}>
          <Clock size={24} /><span className="text-[10px] font-bold">計時</span>
        </button>
        <button onClick={() => setActiveTab('logs')} className={`flex flex-col items-center gap-1 ${activeTab === 'logs' ? 'text-indigo-600' : 'text-slate-400'}`}>
          <Utensils size={24} /><span className="text-[10px] font-bold">日誌</span>
        </button>
        <button onClick={() => setActiveTab('weight')} className={`flex flex-col items-center gap-1 ${activeTab === 'weight' ? 'text-indigo-600' : 'text-slate-400'}`}>
          <TrendingUp size={24} /><span className="text-[10px] font-bold">體重</span>
        </button>
      </nav>

      <style>{`
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 12s linear infinite; }
      `}</style>
    </div>
  );
}
