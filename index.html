<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>168 å¥åº·è¿½è¹¤ App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    
    <!-- Babel & Firebase -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 12s linear infinite; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = window.Recharts;

        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyC1tQrufiWrCou-C0ibw5y5KHcFVJL-CcY",
            authDomain: "heathtracker.firebaseapp.com",
            projectId: "heathtracker",
            storageBucket: "heathtracker.firebasestorage.app",
            messagingSenderId: "656865338644",
            appId: "1:656865338644:web:8707edf3db8c398297ce01",
            measurementId: "G-9600W2EDXF"
        };

        // åˆå§‹åŒ– Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "heathtracker";

        function App() {
            const [user, setUser] = useState(null);
            const [isDemoMode, setIsDemoMode] = useState(false);
            const [activeTab, setActiveTab] = useState('fasting');
            const [weightLogs, setWeightLogs] = useState([]);
            const [isFasting, setIsFasting] = useState(false);
            const [fastingStartTime, setFastingStartTime] = useState(null);
            const [timeLeft, setTimeLeft] = useState("");

            // 1. èº«ä»½é©—è­‰é‚è¼¯ï¼šè™•ç†åŒ¿åç™»å…¥å—é™å•é¡Œ
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    if (u) {
                        setUser(u);
                        setIsDemoMode(false);
                    } else {
                        auth.signInAnonymously().catch(err => {
                            console.error("Auth Error:", err);
                            if (err.code === 'auth/admin-restricted-operation') {
                                // é€²å…¥é è¦½æ¨¡å¼ï¼Œè®“ä½¿ç”¨è€…ä»å¯æ“ä½œ UI
                                setIsDemoMode(true);
                                setUser({ uid: "PREVIEW_USER" });
                            }
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            // 2. æ•¸æ“šç›£è½ (åƒ…åœ¨éé è¦½æ¨¡å¼ä¸‹é€£ç·š Firestore)
            useEffect(() => {
                if (!user || isDemoMode) return;

                const basePath = `artifacts/${appId}/users/${user.uid}`;
                
                const unsubWeight = db.collection(`${basePath}/weight`).onSnapshot(snap => {
                    const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setWeightLogs(data.sort((a, b) => new Date(a.date) - new Date(b.date)));
                }, err => console.error("Firestore Error:", err));

                const unsubFasting = db.doc(`${basePath}/settings/fastingState`).onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        setIsFasting(data.isFasting);
                        setFastingStartTime(data.startTime?.toDate());
                    }
                }, err => console.error("Firestore Error:", err));

                return () => { unsubWeight(); unsubFasting(); };
            }, [user, isDemoMode]);

            // 3. è¨ˆæ™‚å™¨é‚è¼¯
            useEffect(() => {
                if (!isFasting || !fastingStartTime) { setTimeLeft(""); return; }
                const timer = setInterval(() => {
                    const diff = new Date() - fastingStartTime;
                    const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                    const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                    const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                    setTimeLeft(`${h}:${m}:${s}`);
                }, 1000);
                return () => clearInterval(timer);
            }, [isFasting, fastingStartTime]);

            const toggleFasting = async () => {
                const newState = !isFasting;
                if (isDemoMode) {
                    setIsFasting(newState);
                    setFastingStartTime(newState ? new Date() : null);
                    return;
                }
                await db.doc(`artifacts/${appId}/users/${user.uid}/settings/fastingState`).set({
                    isFasting: newState,
                    startTime: newState ? firebase.firestore.Timestamp.now() : null
                });
            };

            const addWeight = async (e) => {
                e.preventDefault();
                const val = e.target.weight.value;
                if (!val) return;

                if (isDemoMode) {
                    const newLog = { 
                        id: Date.now().toString(), 
                        value: parseFloat(val), 
                        date: new Date().toISOString().split('T')[0] 
                    };
                    setWeightLogs(prev => [...prev, newLog].sort((a, b) => new Date(a.date) - new Date(b.date)));
                    e.target.reset();
                    return;
                }

                await db.collection(`artifacts/${appId}/users/${user.uid}/weight`).add({
                    value: parseFloat(val),
                    date: new Date().toISOString().split('T')[0],
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                e.target.reset();
            };

            if (!user && !isDemoMode) return <div className="flex h-screen items-center justify-center text-slate-400">é€£ç·šä¸­...</div>;

            return (
                <div className="min-h-screen pb-24">
                    {isDemoMode && (
                        <div className="bg-amber-500 text-white text-[11px] py-1 px-4 text-center font-bold sticky top-0 z-50 shadow-md">
                            âš ï¸ é è¦½æ¨¡å¼ï¼šè«‹è‡³ Firebase å•Ÿç”¨ã€ŒåŒ¿åç™»å…¥ã€ä»¥å„²å­˜è³‡æ–™
                        </div>
                    )}

                    <header className="bg-white p-4 shadow-sm sticky top-0 z-10 flex justify-between items-center">
                        <h1 className="text-xl font-bold text-indigo-600">å¥åº·è¿½è¹¤ 168</h1>
                        <span className="text-[10px] text-slate-400 bg-slate-100 px-2 py-1 rounded">
                            {isDemoMode ? "PREVIEW" : `UID: ${user.uid.slice(0,8)}`}
                        </span>
                    </header>

                    <main className="max-w-md mx-auto p-4 space-y-6">
                        {activeTab === 'fasting' && (
                            <div className="bg-white rounded-3xl p-8 shadow-xl text-center border border-slate-100">
                                <h2 className="text-slate-500 font-medium mb-2">{isFasting ? 'æ–·é£Ÿä¸­' : 'é€²é£Ÿå€é–“'}</h2>
                                <div className="text-5xl font-mono font-bold text-slate-800 my-6">{isFasting ? timeLeft : "00:00:00"}</div>
                                <div className="relative w-48 h-48 mx-auto mb-8 flex items-center justify-center">
                                    <div className={`absolute inset-0 rounded-full border-8 ${isFasting ? 'border-indigo-100' : 'border-emerald-100'}`}></div>
                                    <div className={`absolute inset-0 rounded-full border-8 ${isFasting ? 'border-indigo-500' : 'border-emerald-500'} border-t-transparent animate-spin-slow`}></div>
                                    <div className="text-indigo-500 font-bold text-2xl">16:8</div>
                                </div>
                                <button onClick={toggleFasting} className={`w-full py-4 rounded-2xl font-bold text-lg text-white shadow-lg transition-all active:scale-95 ${isFasting ? 'bg-slate-800' : 'bg-indigo-600'}`}>
                                    {isFasting ? 'çµæŸæ–·é£Ÿ' : 'é–‹å§‹æ–·é£Ÿ'}
                                </button>
                            </div>
                        )}

                        {activeTab === 'weight' && (
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-3xl shadow-sm">
                                    <h3 className="font-bold mb-4 text-slate-700">é«”é‡è¶¨å‹¢</h3>
                                    <div className="h-48 w-full">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <LineChart data={weightLogs}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                <XAxis dataKey="date" hide />
                                                <YAxis domain={['dataMin - 1', 'dataMax + 1']} hide />
                                                <Tooltip contentStyle={{borderRadius:'10px', border:'none'}} />
                                                <Line type="monotone" dataKey="value" stroke="#6366f1" strokeWidth={3} dot={{r:4, fill:'#6366f1'}} />
                                            </LineChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                                <form onSubmit={addWeight} className="bg-white p-4 rounded-2xl shadow-sm flex gap-2 border border-slate-100">
                                    <input name="weight" type="number" step="0.1" placeholder="ä»Šæ—¥é«”é‡ (kg)" className="flex-1 bg-slate-50 border-none rounded-xl px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none" />
                                    <button type="submit" className="bg-indigo-600 text-white px-6 rounded-xl font-bold shadow-md">+</button>
                                </form>
                                <div className="space-y-2">
                                    {weightLogs.slice().reverse().map(log => (
                                        <div key={log.id} className="bg-white px-4 py-3 rounded-xl flex justify-between items-center shadow-sm">
                                            <span className="font-medium text-slate-700">{log.value} kg</span>
                                            <span className="text-xs text-slate-400">{log.date}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {isDemoMode && (
                            <div className="mt-8 p-6 bg-red-50 rounded-2xl border border-red-200 shadow-sm">
                                <h2 className="text-red-700 font-bold text-lg mb-2">ç„¡æ³•é€£çµé›²ç«¯è³‡æ–™åº«</h2>
                                <p className="text-red-600 text-sm mb-4">ç›®å‰çš„æ“ä½œåƒ…ä¾›é è¦½ï¼Œé‡æ–°æ•´ç†å¾Œè¨˜éŒ„å°‡æœƒéºå¤±ã€‚</p>
                                <div className="text-left text-xs text-slate-600 bg-white p-4 rounded-xl space-y-2">
                                    <p className="font-bold text-slate-800 underline">ä¿®å¾©æ­¥é©Ÿï¼š</p>
                                    <ol className="list-decimal ml-4 space-y-1">
                                        <li>é–‹å•Ÿ <a href="https://console.firebase.google.com/" target="_blank" className="text-blue-600 font-bold">Firebase Console</a></li>
                                        <li>é¸æ“‡å°ˆæ¡ˆ <b>heathtracker</b></li>
                                        <li>é»é¸ <b>Authentication</b> > <b>Sign-in method</b></li>
                                        <li>å•Ÿç”¨ <b>Anonymous (åŒ¿å)</b> æä¾›æ¥­è€…</li>
                                    </ol>
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-slate-100 flex justify-around p-3 z-20 pb-8">
                        <button onClick={() => setActiveTab('fasting')} className={`flex flex-col items-center gap-1 transition-colors ${activeTab === 'fasting' ? 'text-indigo-600' : 'text-slate-400'}`}>
                            <div className="text-xl">â±ï¸</div>
                            <span className="text-[10px] font-bold">æ–·é£Ÿè¨ˆæ™‚</span>
                        </button>
                        <button onClick={() => setActiveTab('weight')} className={`flex flex-col items-center gap-1 transition-colors ${activeTab === 'weight' ? 'text-indigo-600' : 'text-slate-400'}`}>
                            <div className="text-xl">ğŸ“ˆ</div>
                            <span className="text-[10px] font-bold">é«”é‡è¿½è¹¤</span>
                        </button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
