<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>168 æ–·é£Ÿèˆ‡é‹å‹•è¿½è¹¤åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ç¢ºä¿ Lucide åœ¨å…¶å®ƒè…³æœ¬ä¹‹å‰è¼‰å…¥ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC1tQrufiWrCou-C0ibw5y5KHcFVJL-CcY",
            authDomain: "heathtracker.firebaseapp.com",
            projectId: "heathtracker",
            storageBucket: "heathtracker.firebasestorage.app",
            messagingSenderId: "656865338644",
            appId: "1:656865338644:web:8c5b96792345e69123456"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'health-tracker-v1';

        // State
        let currentUser = null;
        let fastingTimer = null;
        let chart = null;
        const geminiApiKey = ""; // ç”±ç’°å¢ƒè‡ªå‹•æ³¨å…¥

        // --- Auth Logic ---
        async function initAuth() {
            try {
                // å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰åˆå§‹æ¬Šæ–
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (tokenError) {
                        console.warn("Custom token failed, falling back to anonymous sign-in:", tokenError);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Critical Auth error:", error);
                showToast("ç™»å…¥é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹");
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserData();
                loadWeightData();
                loadFoodLogs();
            }
        });

        // --- UI Logic ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            if (window.lucide) lucide.createIcons();
        };

        // --- Data Logic (Profile) ---
        window.saveProfile = async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const data = {
                gender: document.getElementById('gender').value,
                age: parseInt(document.getElementById('age').value),
                height: parseFloat(document.getElementById('height').value),
                weight: parseFloat(document.getElementById('weight').value),
                activity: document.getElementById('activity').value,
                updatedAt: new Date().toISOString()
            };

            let bmr = (10 * data.weight) + (6.25 * data.height) - (5 * data.age);
            bmr = data.gender === 'male' ? bmr + 5 : bmr - 161;
            
            const activityMultipliers = { sedentary: 1.2, light: 1.375, moderate: 1.55, active: 1.725 };
            const tdee = bmr * activityMultipliers[data.activity];

            data.bmr = Math.round(bmr);
            data.tdee = Math.round(tdee);

            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'info'), data);
            updateProfileUI(data);
            showToast("å€‹äººè³‡æ–™å·²æ›´æ–°");
        };

        function updateProfileUI(data) {
            document.getElementById('display-bmr').innerText = data.bmr;
            document.getElementById('display-tdee').innerText = data.tdee;
        }

        async function loadUserData() {
            if (!currentUser) return;
            try {
                const snap = await getDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'info'));
                if (snap.exists()) {
                    const data = snap.data();
                    document.getElementById('gender').value = data.gender;
                    document.getElementById('age').value = data.age;
                    document.getElementById('height').value = data.height;
                    document.getElementById('weight').value = data.weight;
                    document.getElementById('activity').value = data.activity;
                    updateProfileUI(data);
                }
            } catch (err) { console.error("Load user data error:", err); }
        }

        // --- Fasting Timer Logic ---
        let fastingStartTime = null;
        window.toggleFasting = () => {
            const btn = document.getElementById('fasting-btn');
            if (!fastingTimer) {
                fastingStartTime = new Date();
                btn.innerText = "çµæŸæ–·é£Ÿ";
                btn.classList.replace('bg-white', 'bg-red-500');
                btn.classList.replace('text-blue-600', 'text-white');
                startTimer();
            } else {
                clearInterval(fastingTimer);
                fastingTimer = null;
                btn.innerText = "é–‹å§‹æ–·é£Ÿ (168)";
                btn.classList.replace('bg-red-500', 'bg-white');
                btn.classList.replace('text-white', 'text-blue-600');
                document.getElementById('timer-display').innerText = "00:00:00";
                document.getElementById('fasting-progress').style.width = '0%';
            }
        };

        function startTimer() {
            fastingTimer = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - fastingStartTime) / 1000);
                const h = String(Math.floor(diff / 3600)).padStart(2, '0');
                const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
                const s = String(diff % 60).padStart(2, '0');
                document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
                
                const progress = Math.min((diff / (16 * 3600)) * 100, 100);
                document.getElementById('fasting-progress').style.width = `${progress}%`;
            }, 1000);
        }

        // --- Weight Chart Logic ---
        window.addWeight = async () => {
            const weightInput = document.getElementById('new-weight');
            const weight = parseFloat(weightInput.value);
            if (!weight || !currentUser) return;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'weights'), {
                    value: weight,
                    date: new Date().toISOString()
                });
                weightInput.value = '';
                showToast("é«”é‡å·²è¨˜éŒ„");
            } catch (err) { console.error("Add weight error:", err); }
        };

        function loadWeightData() {
            if (!currentUser) return;
            const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'weights'), orderBy('date', 'asc'));
            onSnapshot(q, (snap) => {
                const labels = [];
                const values = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    labels.push(new Date(data.date).toLocaleDateString());
                    values.push(data.value);
                });
                renderChart(labels, values);
            }, (err) => console.error("Weight fetch error:", err));
        }

        function renderChart(labels, values) {
            const canvas = document.getElementById('weightChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'é«”é‡ (kg)',
                        data: values,
                        borderColor: '#3b82f6',
                        tension: 0.1,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- Food Analysis Logic ---
        window.analyzeFood = async () => {
            const fileInput = document.getElementById('food-image');
            if (!fileInput.files[0]) return;

            const loading = document.getElementById('food-loading');
            loading.classList.remove('hidden');
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                
                const prompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­ç‡Ÿé¤Šå¸«ã€‚è«‹åˆ†æé€™å¼µç…§ç‰‡ï¼ˆé£Ÿç‰©æˆ– Garmin é‹å‹•æˆªåœ–ï¼‰ã€‚å¦‚æœæ˜¯é£Ÿç‰©ï¼Œè«‹è¾¨è­˜åç¨±ã€ä¼°è¨ˆç†±é‡ï¼ˆkcalï¼‰ä¸¦çµ¦äºˆ168æ–·é£Ÿå»ºè­°ã€‚å¦‚æœæ˜¯é‹å‹•æˆªåœ–ï¼Œè«‹æ‘˜è¦é‹å‹•é‡ã€‚è«‹åƒ…å›è¦† JSON æ ¼å¼ç‰©ä»¶ï¼Œä¸è¦åŒ…å« Markdown èªæ³•æ¨™ç±¤ï¼Œç¯„ä¾‹ï¼š{ \"food\": \"åç¨±\", \"calories\": æ•¸å­—, \"advice\": \"å»ºè­°\" }";

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, {
                        method: 'POST',
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inlineData: { mimeType: "image/png", data: base64Data } }
                                ]
                            }]
                        })
                    });
                    
                    const result = await response.json();
                    const text = result.candidates[0].content.parts[0].text;
                    const cleanedText = text.replace(/```json/g, "").replace(/```/g, "").trim();
                    const analysis = JSON.parse(cleanedText);
                    
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'foodLogs'), {
                        ...analysis,
                        timestamp: new Date().toISOString()
                    });
                    showToast("åˆ†æå®Œæˆ");
                } catch (error) {
                    console.error("AI Analysis error:", error);
                    showToast("åˆ†æå¤±æ•—");
                } finally {
                    loading.classList.add('hidden');
                    fileInput.value = '';
                }
            };
            reader.readAsDataURL(file);
        };

        function loadFoodLogs() {
            if (!currentUser) return;
            const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'foodLogs'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('food-logs-container');
                container.innerHTML = '';
                snap.forEach(doc => {
                    const log = doc.data();
                    const div = document.createElement('div');
                    div.className = 'bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-500 mb-3';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-gray-800">${log.food || 'å¥åº·ç´€éŒ„'}</h4>
                            <span class="text-[10px] text-gray-400">${new Date(log.timestamp).toLocaleString()}</span>
                        </div>
                        <p class="text-orange-600 font-bold my-1">${log.calories} kcal</p>
                        <p class="text-sm text-gray-600 leading-relaxed">ğŸ’¡ ${log.advice}</p>
                    `;
                    container.appendChild(div);
                });
            }, (err) => console.error("Food logs fetch error:", err));
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Initialize on load
        window.addEventListener('load', () => {
            if (window.lucide) lucide.createIcons();
            initAuth();
        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        input, select { outline: none; }
        input:focus { border-color: #3b82f6; }
    </style>
</head>
<body class="pb-24">

    <!-- Header -->
    <header class="bg-white shadow-sm p-4 sticky top-0 z-30">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-blue-600 flex items-center gap-2">
                <i data-lucide="heart-pulse" class="w-6 h-6"></i> å¥åº·è¿½è¹¤åŠ©æ‰‹
            </h1>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">

        <!-- Tab 1: 168 æ–·é£Ÿæ§åˆ¶å° -->
        <section id="fasting-tab" class="tab-content space-y-4">
            <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl p-8 text-white text-center shadow-xl">
                <h2 class="text-sm uppercase tracking-widest opacity-80 mb-2">Fasting Timer</h2>
                <div id="timer-display" class="text-5xl font-mono font-bold my-4">00:00:00</div>
                <div class="w-full bg-white/20 h-2.5 rounded-full mb-8 overflow-hidden">
                    <div id="fasting-progress" class="bg-white h-full rounded-full transition-all duration-700" style="width: 0%"></div>
                </div>
                <button onclick="toggleFasting()" id="fasting-btn" class="bg-white text-blue-600 hover:bg-blue-50 font-bold py-4 px-8 rounded-2xl shadow-lg transition-all active:scale-95 w-full text-lg">
                    é–‹å§‹æ–·é£Ÿ (168)
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-xs text-gray-400 mb-1 uppercase font-bold">æ¯æ—¥æ¶ˆè€— (TDEE)</p>
                    <p class="text-2xl font-black text-gray-800"><span id="display-tdee">--</span> <small class="text-xs font-normal">kcal</small></p>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-xs text-gray-400 mb-1 uppercase font-bold">åŸºç¤ä»£è¬ (BMR)</p>
                    <p class="text-2xl font-black text-gray-800"><span id="display-bmr">--</span> <small class="text-xs font-normal">kcal</small></p>
                </div>
            </div>
        </section>

        <!-- Tab 2: é£²é£Ÿ AI åˆ†æ -->
        <section id="food-tab" class="tab-content hidden space-y-4">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i data-lucide="camera" class="text-blue-500"></i> AI æ™ºèƒ½åˆ†æ
                </h3>
                <p class="text-sm text-gray-500 mb-4">æ‹ç…§è¨˜éŒ„é£Ÿç‰©æˆ–ä¸Šå‚³ Garmin é‹å‹•æ•¸æ“šã€‚</p>
                <div class="space-y-3">
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-200 rounded-2xl cursor-pointer hover:bg-gray-50 transition-colors">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i data-lucide="upload-cloud" class="w-8 h-8 text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-500">é»æ“Šæˆ–æ‹–æ”¾ç…§ç‰‡</p>
                        </div>
                        <input type="file" id="food-image" accept="image/*" class="hidden" onchange="analyzeFood()" />
                    </label>
                </div>
                <div id="food-loading" class="hidden mt-6 text-center">
                    <div class="animate-spin inline-block w-8 h-8 border-[3px] border-current border-t-transparent text-blue-600 rounded-full"></div>
                    <p class="text-sm text-blue-600 mt-3 font-medium">ç‡Ÿé¤Šå¸« AI æ­£åœ¨åˆ†æä¸­...</p>
                </div>
            </div>

            <div id="food-logs-container" class="space-y-3">
                <!-- Food Logs will appear here -->
            </div>
        </section>

        <!-- Tab 3: é«”é‡è¿½è¹¤ -->
        <section id="weight-tab" class="tab-content hidden space-y-4">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i data-lucide="line-chart" class="text-blue-500"></i> é«”é‡ç´€éŒ„
                </h3>
                <div class="h-64 mb-6">
                    <canvas id="weightChart"></canvas>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="new-weight" placeholder="kg" step="0.1" class="flex-1 border border-gray-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-100 transition-all">
                    <button onclick="addWeight()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-md active:scale-95 transition-transform">
                        ç´€éŒ„é«”é‡
                    </button>
                </div>
            </div>
        </section>

        <!-- Tab 4: å€‹äººè¨­å®š -->
        <section id="profile-tab" class="tab-content hidden space-y-4">
            <form onsubmit="saveProfile(event)" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-5">
                <h3 class="font-bold text-lg mb-2">å€‹äººç”Ÿç†è¨­å®š</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">æ€§åˆ¥</label>
                        <select id="gender" class="w-full border border-gray-200 p-3 rounded-xl bg-gray-50">
                            <option value="male">ç”·æ€§ (Male)</option>
                            <option value="female">å¥³æ€§ (Female)</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">å¹´é½¡</label>
                            <input type="number" id="age" class="w-full border border-gray-200 p-3 rounded-xl bg-gray-50" placeholder="25">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">æ´»å‹•é‡</label>
                            <select id="activity" class="w-full border border-gray-200 p-3 rounded-xl bg-gray-50">
                                <option value="sedentary">ä¹…å/ç„¡é‹å‹•</option>
                                <option value="light">è¼•é‡é‹å‹•</option>
                                <option value="moderate">ä¸­åº¦é‹å‹•</option>
                                <option value="active">é«˜åº¦é‹å‹•</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">èº«é«˜ (cm)</label>
                            <input type="number" id="height" class="w-full border border-gray-200 p-3 rounded-xl bg-gray-50" placeholder="170">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">é«”é‡ (kg)</label>
                            <input type="number" id="weight" class="w-full border border-gray-200 p-3 rounded-xl bg-gray-50" placeholder="65">
                        </div>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold mt-4 shadow-lg hover:bg-blue-700 active:scale-95 transition-all">
                    æ›´æ–°ä¸¦è¨ˆç®—å¥åº·æ•¸æ“š
                </button>
            </form>
        </section>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-t flex justify-around p-3 max-w-md mx-auto z-40">
        <button onclick="switchTab('fasting-tab')" class="flex flex-col items-center px-4 py-2 rounded-xl text-gray-400 focus:text-blue-600 transition-colors">
            <i data-lucide="timer" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-bold">æ–·é£Ÿ</span>
        </button>
        <button onclick="switchTab('food-tab')" class="flex flex-col items-center px-4 py-2 rounded-xl text-gray-400 focus:text-blue-600 transition-colors">
            <i data-lucide="scan-face" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-bold">AIè¾¨è­˜</span>
        </button>
        <button onclick="switchTab('weight-tab')" class="flex flex-col items-center px-4 py-2 rounded-xl text-gray-400 focus:text-blue-600 transition-colors">
            <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-bold">è¶¨å‹¢</span>
        </button>
        <button onclick="switchTab('profile-tab')" class="flex flex-col items-center px-4 py-2 rounded-xl text-gray-400 focus:text-blue-600 transition-colors">
            <i data-lucide="settings" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-bold">è¨­å®š</span>
        </button>
    </nav>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-900/90 text-white px-6 py-3 rounded-2xl text-sm hidden z-50 shadow-2xl backdrop-blur-sm transition-opacity"></div>

</body>
</html>
